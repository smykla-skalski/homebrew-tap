name: Update Formula

on:
  repository_dispatch:
    types: [new-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (e.g., 0.1.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  update-formula:
    name: Update klab formula
    runs-on: macos-latest

    steps:
      - name: Checkout tap
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Generate GitHub App token
        id: github-app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf  # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_APP_PRIVATE_KEY }}
          owner: smykla-skalski
          repositories: klab

      - name: Set version
        id: version
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_VERSION: ${{ inputs.version }}
          PAYLOAD_VERSION: ${{ github.event.client_payload.version }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            VERSION="$INPUT_VERSION"
          else
            VERSION="$PAYLOAD_VERSION"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Updating to version: ${VERSION}"

      - name: Download release artifact
        env:
          VERSION: ${{ steps.version.outputs.version }}
          GH_TOKEN: ${{ steps.github-app-token.outputs.token }}
        run: |
          gh release download "v${VERSION}" \
            --repo smykla-skalski/klab \
            --pattern "klab-darwin-arm64" \
            --output klab-darwin-arm64
          chmod +x klab-darwin-arm64

      - name: Calculate SHA256
        id: sha256
        run: |
          SHA256=$(shasum -a 256 klab-darwin-arm64 | awk '{print $1}')
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"
          echo "SHA256: ${SHA256}"

      - name: Update formula
        env:
          VERSION: ${{ steps.version.outputs.version }}
          SHA256: ${{ steps.sha256.outputs.sha256 }}
        run: |
          # Update version
          sed -i '' "s/version \".*\"/version \"${VERSION}\"/" Formula/klab.rb

          # Update URL (matches any version format: 1.0.0, 1.0.0-test, 1.0.0-alpha.1, etc.)
          sed -i '' "s|/v[^/]*/klab-darwin-arm64|/v${VERSION}/klab-darwin-arm64|" Formula/klab.rb

          # Update SHA256 (handle placeholder case)
          sed -i '' "s/sha256 \".*\"/sha256 \"${SHA256}\"/" Formula/klab.rb

          echo "Updated formula:"
          cat Formula/klab.rb

      - name: Commit and push
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/klab.rb
          git diff --staged --quiet && exit 0
          git commit -m "chore(formula): update klab to v${VERSION}" \
            -m "Automated update triggered by klab release v${VERSION}"
          git push
